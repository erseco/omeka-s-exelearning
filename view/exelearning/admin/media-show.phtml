<?php
/**
 * Admin media show partial - displays eXeLearning content in an iframe.
 *
 * @var \Laminas\View\Renderer\PhpRenderer $this
 * @var \Omeka\Api\Representation\MediaRepresentation $media
 * @var string $previewUrl
 */

// Check if user can edit this media
$canEdit = $this->identity() && $this->userIsAllowed('Omeka\Entity\Media', 'update');

$editUrl = $this->url('admin/exelearning-editor', ['action' => 'edit', 'id' => $media->id()]);
$mediaId = $media->id();

// Load modal assets
$this->headLink()->appendStylesheet($this->assetUrl('css/exelearning-editor.css', 'ExeLearning'));
$this->headScript()->appendFile($this->assetUrl('js/exelearning-editor.js', 'ExeLearning'));
?>

<style>
.exelearning-admin-viewer {
    margin: 1rem 0;
    border: 1px solid #dfdfdf;
    border-radius: 3px;
    background: #fff;
}
.exelearning-admin-viewer h4 {
    margin: 0;
    padding: 0.75rem 1rem;
    background: #f7f7f7;
    border-bottom: 1px solid #dfdfdf;
    font-size: 14px;
    font-weight: 600;
}
.exelearning-admin-viewer .viewer-controls {
    padding: 0.5rem 1rem;
    background: #f7f7f7;
    border-bottom: 1px solid #dfdfdf;
    display: flex;
    gap: 0.5rem;
    align-items: center;
}
.exelearning-admin-viewer .viewer-controls a,
.exelearning-admin-viewer .viewer-controls button {
    font-size: 13px;
}
.exelearning-admin-viewer .viewer-controls .edit-btn {
    background: #2271b1;
    color: #fff;
    border: none;
    cursor: pointer;
    padding: 0.4rem 0.8rem;
    border-radius: 3px;
    text-decoration: none;
}
.exelearning-admin-viewer .viewer-controls .edit-btn:hover {
    background: #135e96;
    color: #fff;
}
.exelearning-admin-viewer .preview-iframe {
    display: block;
    width: 100%;
    height: 600px;
    border: none;
}
</style>

<div class="exelearning-admin-viewer">
    <h4><?= $this->translate('eXeLearning Preview') ?></h4>
    <div class="viewer-controls">
        <a href="<?= $this->escapeHtmlAttr($previewUrl) ?>" target="_blank" class="button">
            <span class="o-icon-external" aria-hidden="true"></span>
            <?= $this->translate('Open in new tab') ?>
        </a>
        <a href="<?= $this->escapeHtmlAttr($media->originalUrl()) ?>" download="<?= $this->escapeHtmlAttr($media->source()) ?>" class="button">
            <span class="o-icon-download" aria-hidden="true"></span>
            <?= $this->translate('Download .elpx') ?>
        </a>
        <?php if ($canEdit): ?>
        <button type="button" class="edit-btn"
                onclick="ExeLearningEditor.open(<?= $mediaId ?>, '<?= $this->escapeJs($editUrl) ?>')">
            <span class="o-icon-edit" aria-hidden="true"></span>
            <?= $this->translate('Edit in eXeLearning') ?>
        </button>
        <?php endif; ?>
    </div>
    <iframe
        class="preview-iframe"
        src="<?= $this->escapeHtmlAttr($previewUrl) ?>"
        sandbox="allow-scripts allow-popups allow-popups-to-escape-sandbox"
        referrerpolicy="no-referrer"
        allowfullscreen></iframe>
</div>

<!-- eXeLearning Editor Modal -->
<div id="exelearning-editor-modal" class="exelearning-editor-modal">
    <div class="exelearning-editor-header">
        <div class="exelearning-editor-title">
            <span class="icon">&#9998;</span>
            <span><?= $this->translate('Edit eXeLearning File') ?></span>
        </div>
        <div class="exelearning-editor-actions">
            <button type="button" id="exelearning-editor-save" class="button button-primary">
                <?= $this->translate('Save to Omeka') ?>
            </button>
            <button type="button" id="exelearning-editor-close" class="button button-secondary">
                <?= $this->translate('Close') ?>
            </button>
        </div>
    </div>
    <iframe id="exelearning-editor-iframe" class="exelearning-editor-iframe" src="about:blank"></iframe>
</div>

<script>
// Add download attribute with original filename to File Derivatives links
(function() {
    var source = <?= json_encode($media->source()) ?>;
    if (!source) return;
    document.querySelectorAll('.meta-group a[href*="/files/original/"]').forEach(function(link) {
        link.setAttribute('download', source);
    });
})();
</script>
