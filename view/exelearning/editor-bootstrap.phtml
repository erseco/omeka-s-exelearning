<?php
/**
 * eXeLearning Editor Bootstrap Template
 *
 * Loads the static PWA version of eXeLearning editor with Omeka S integration.
 * The static editor is built with `make build-editor` and placed in dist/static/.
 *
 * @var \Laminas\View\Renderer\PhpRenderer $this
 * @var \Omeka\Api\Representation\MediaRepresentation $media
 * @var array $config
 * @var string $editorBaseUrl
 */

// Check if static editor exists
$staticIndex = dirname(__DIR__, 2) . '/dist/static/index.html';
if (!file_exists($staticIndex)) {
    $isDevInstall = ('0.0.0' === ($config['version'] ?? '0.0.0'));
    echo '<h1>Error</h1>';
    if ($isDevInstall) {
        echo '<p>eXeLearning editor not found. You appear to have cloned this repository directly.</p>';
        echo '<p>Please either:</p>';
        echo '<ol>';
        echo '<li>Download the module from <a href="https://github.com/ateeducacion/omeka-s-exelearning/releases">GitHub Releases</a></li>';
        echo '<li>Build the editor with: <code>make build-editor</code></li>';
        echo '</ol>';
    } else {
        echo '<p>eXeLearning editor files are missing. Please reinstall the module from the official release.</p>';
    }
    return;
}

// Load the static index.html
$template = file_get_contents($staticIndex);

if (empty($template)) {
    echo '<h1>Error</h1>';
    echo '<p>Failed to load eXeLearning editor template.</p>';
    return;
}

// Prepare JSON-safe configuration
$configJson = json_encode($config, JSON_HEX_TAG | JSON_HEX_APOS | JSON_HEX_QUOT | JSON_HEX_AMP);
$editorBaseUrlJs = json_encode($editorBaseUrl, JSON_HEX_TAG | JSON_HEX_APOS | JSON_HEX_QUOT | JSON_HEX_AMP);

// Build the configuration script
$configScript = <<<SCRIPT
    <!-- Omeka S Integration Configuration -->
    <script>
        // Omeka S Integration Configuration
        window.__OMEKA_EXE_CONFIG__ = {$configJson};

        // Override static mode detection for Omeka S
        window.__EXE_STATIC_MODE__ = true;
        window.__EXE_OMEKA_MODE__ = true;

        // Embedding configuration for the editor.
        // The editor reads this in RuntimeConfig.fromEnvironment() and applies
        // basePath in App.initializeModeDetection(). UI hiding is done via
        // data attributes on <body> + CSS in main.scss.
        window.__EXE_EMBEDDING_CONFIG__ = {
            basePath: {$editorBaseUrlJs},
            parentOrigin: window.location.origin,
            trustedOrigins: [window.location.origin],
            hideUI: {
                fileMenu: true,
                saveButton: true,
                userMenu: true,
            },
        };

        // Disable Service Worker in Omeka mode to prevent path conflicts
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register = function() {
                console.log("[Omeka Mode] Service worker registration disabled");
                return Promise.resolve({ scope: "" });
            };
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                registrations.forEach(function(registration) {
                    registration.unregister();
                    console.log("[Omeka Mode] Service worker unregistered");
                });
            });
        }

        // Handle CSS/JS 404 errors gracefully
        (function() {
            var originalFetch = window.fetch;
            window.fetch = function(input, init) {
                var url = typeof input === "string" ? input : (input && input.url) || "";
                return originalFetch.apply(this, arguments).then(function(response) {
                    if (!response.ok && (url.includes(".css") || url.includes("idevices"))) {
                        console.warn("[Omeka Mode] Fetch 404 fallback:", url);
                        return new Response("/* empty fallback */", {
                            status: 200,
                            headers: { "Content-Type": "text/css" }
                        });
                    }
                    return response;
                }).catch(function(error) {
                    if (url.includes(".css") || url.includes("idevices")) {
                        console.warn("[Omeka Mode] Fetch error fallback:", url);
                        return new Response("/* empty fallback */", {
                            status: 200,
                            headers: { "Content-Type": "text/css" }
                        });
                    }
                    throw error;
                });
            };

            // Patch jQuery AJAX to handle 404s for CSS/idevice files.
            var patchJQuery = function($) {
                if (!$ || !$.ajaxTransport) return;
                $.ajaxTransport("+*", function(options) {
                    var url = options.url || "";
                    if (!(url.includes(".css") || url.includes("idevices"))) return;
                    return {
                        send: function(headers, completeCallback) {
                            var xhr = new XMLHttpRequest();
                            xhr.open(options.type || "GET", url, true);
                            xhr.onload = function() {
                                if (xhr.status >= 200 && xhr.status < 300) {
                                    completeCallback(xhr.status, xhr.statusText, { text: xhr.responseText });
                                } else {
                                    console.warn("[Omeka Mode] jQuery 404 fallback:", url);
                                    completeCallback(200, "OK", { text: "/* empty fallback */" });
                                }
                            };
                            xhr.onerror = function() {
                                console.warn("[Omeka Mode] jQuery error fallback:", url);
                                completeCallback(200, "OK", { text: "/* empty fallback */" });
                            };
                            xhr.send();
                        },
                        abort: function() {}
                    };
                });
            };
            if (window.jQuery) {
                patchJQuery(window.jQuery);
            } else {
                Object.defineProperty(window, "jQuery", {
                    configurable: true,
                    set: function(val) {
                        Object.defineProperty(window, "jQuery", {
                            configurable: true, writable: true, enumerable: true, value: val
                        });
                        patchJQuery(val);
                    },
                    get: function() { return undefined; }
                });
            }
        })();
    </script>
SCRIPT;

// Get the correct module base URL for assets (without dist/static)
$moduleBaseUrl = dirname(dirname($editorBaseUrl));
$bridgeScript = '<script src="' . htmlspecialchars($moduleBaseUrl, ENT_QUOTES, 'UTF-8') . '/asset/js/omeka-exe-bridge.js"></script>';

// Omeka-specific styles
$omekaStyles = <<<STYLES
    <!-- Omeka-specific styles -->
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        /* Omeka notification */
        .omeka-exe-notification {
            position: fixed;
            top: 60px;
            right: 10px;
            z-index: 10001;
            padding: 12px 20px;
            border-radius: 4px;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: opacity 0.3s ease;
        }
        .omeka-exe-notification--success {
            background: #00a32a;
            color: white;
        }
        .omeka-exe-notification--error {
            background: #d63638;
            color: white;
        }
        .omeka-exe-notification--fade {
            opacity: 0;
        }
    </style>
STYLES;

// Insert configuration, bridge script, and styles before </head>
$template = str_replace('</head>', $configScript . $bridgeScript . $omekaStyles . '</head>', $template);

// Add <base> tag to set base URL for relative paths
$baseTag = '<base href="' . htmlspecialchars($editorBaseUrl, ENT_QUOTES, 'UTF-8') . '/">';
$template = preg_replace('/(<head[^>]*>)/i', '$1' . $baseTag, $template);

// Fix relative paths starting with "./"
$template = preg_replace(
    '/(?<=["\'])\.\//',
    htmlspecialchars($editorBaseUrl, ENT_QUOTES, 'UTF-8') . '/',
    $template
);

// Output headers
if (!headers_sent()) {
    header('Content-Type: text/html; charset=utf-8');
    header('X-Content-Type-Options: nosniff');
}

// Output the processed template
echo $template;
